<!DOCTYPE html>
<html lang="en">
    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBKcmEczz9H0OiPvAe3PkzEvbfcMNyjKm8",
  authDomain: "mamalaka-wiki.firebaseapp.com",
  projectId: "mamalaka-wiki",
  storageBucket: "mamalaka-wiki.firebasestorage.app",
  messagingSenderId: "179732642622",
  appId: "1:179732642622:web:13742db6cd8cd7031fca6f",
  measurementId: "G-MWRYBY9FSV"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiBuilder - Collaborative Wiki Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4B4BC8'
                    }
                }
            }
        }
    </script>
    <style>
        .markdown-content h1 { @apply text-3xl font-bold mb-4 text-gray-900 dark:text-white; }
        .markdown-content h2 { @apply text-2xl font-bold mb-3 text-gray-800 dark:text-gray-100; }
        .markdown-content h3 { @apply text-xl font-bold mb-2 text-gray-700 dark:text-gray-200; }
        .markdown-content p { @apply mb-4 text-gray-700 dark:text-gray-300 leading-relaxed; }
        .markdown-content ul { @apply mb-4 ml-6 list-disc text-gray-700 dark:text-gray-300; }
        .markdown-content ol { @apply mb-4 ml-6 list-decimal text-gray-700 dark:text-gray-300; }
        .markdown-content li { @apply mb-1; }
        .markdown-content blockquote { @apply border-l-4 border-primary pl-4 italic text-gray-600 dark:text-gray-400 mb-4; }
        .markdown-content code { @apply bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-sm font-mono; }
        .markdown-content pre { @apply bg-gray-100 dark:bg-gray-800 p-4 rounded mb-4 overflow-x-auto; }
        .markdown-content pre code { @apply bg-transparent px-0 py-0; }
        .markdown-content a { @apply text-primary hover:text-primary-dark underline; }
        .markdown-content table { @apply w-full border-collapse border border-gray-300 dark:border-gray-600 mb-4; }
        .markdown-content th, .markdown-content td { @apply border border-gray-300 dark:border-gray-600 px-3 py-2 text-left; }
        .markdown-content th { @apply bg-gray-100 dark:bg-gray-800 font-semibold; }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <!-- Header -->
    <header class="bg-primary text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold cursor-pointer" onclick="showWikiList()">
                        <i class="fas fa-book-open mr-2"></i>WikiBuilder
                    </h1>
                    <div id="breadcrumb" class="hidden md:flex items-center space-x-2 text-sm opacity-90">
                        <!-- Breadcrumb will be populated dynamically -->
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search pages..." 
                            class="bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-70 px-4 py-2 rounded-lg w-64 text-base focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
                            onkeypress="handleSearchKeypress(event)"
                        >
                        <i class="fas fa-search absolute right-3 top-3 text-white opacity-70"></i>
                    </div>
                    <div id="userDropdown" class="relative">
                        <button onclick="toggleUserDropdown()" class="flex items-center space-x-2 bg-white bg-opacity-20 px-3 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                            <i class="fas fa-user"></i>
                            <span id="currentUserName">Guest</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-2 z-20">
                            <div id="loginSection">
                                <a href="#" onclick="showLogin()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                                </a>
                            </div>
                            <div id="userSection" class="hidden">
                                <a href="#" onclick="showUserManagement()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-users mr-2"></i>Manage Users
                                </a>
                                <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                                <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </a>
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleSidebar()" class="md:hidden">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out fixed md:relative z-10 h-full">
            <div class="p-4">
                <div class="mb-6">
                    <button onclick="showWikiList()" class="w-full bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg mb-3 transition-colors">
                        <i class="fas fa-home mr-2"></i>All Wikis
                    </button>
                    <button id="createWikiBtn" onclick="showCreateWiki()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Create Wiki
                    </button>
                </div>

                <div id="currentWikiInfo" class="hidden">
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-3">Current Wiki</h3>
                    <div class="mb-4 p-3 bg-white dark:bg-gray-700 rounded-lg">
                        <h4 id="currentWikiName" class="font-medium text-gray-800 dark:text-gray-200"></h4>
                        <p id="currentWikiDesc" class="text-sm text-gray-600 dark:text-gray-400 mt-1"></p>
                        <div id="currentUserRole" class="text-xs text-primary font-medium mt-2"></div>
                    </div>
                    
                    <button id="createPageBtn" onclick="showCreatePage()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg mb-4 transition-colors">
                        <i class="fas fa-file-plus mr-2"></i>New Page
                    </button>

                    <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Pages</h4>
                    <div id="pagesList" class="space-y-1 max-h-64 overflow-y-auto">
                        <!-- Pages will be populated dynamically -->
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6">
            <!-- Login View -->
            <div id="loginView" class="hidden max-w-md mx-auto">
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6 text-center">Login</h2>
                <form onsubmit="performLogin(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
                        <input type="text" id="loginUsername" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 text-base">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 text-base">
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="flex-1 bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg transition-colors">
                            Login
                        </button>
                        <button type="button" onclick="showWikiList()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
                <p class="mt-4 text-sm text-gray-600 dark:text-gray-400 text-center">
                    Login
                </p>
            </div>

            <!-- User Management View -->
            <div id="userManagementView" class="hidden max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">User Management</h2>
                    <p class="text-gray-600 dark:text-gray-400">Manage user roles and permissions for this wiki.</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Wiki Users</h3>
                        <button onclick="showAddUser()" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>Add User
                        </button>
                    </div>
                    <div id="usersList" class="space-y-3">
                        <!-- Users list will be populated here -->
                    </div>
                </div>

                <div id="addUserForm" class="hidden mt-6 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Add User to Wiki</h3>
                    <form onsubmit="addUserToWiki(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
                                <input type="text" id="addUserUsername" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Role</label>
                                <select id="addUserRole" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 text-base">
                                    <option value="viewer">Viewer</option>
                                    <option value="contributor">Contributor</option>
                                    <option value="editor">Editor</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg transition-colors">
                                Add User
                            </button>
                            <button type="button" onclick="hideAddUser()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Wiki List View -->
            <div id="wikiListView" class="max-w-6xl mx-auto">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Your Wikis</h2>
                    <p class="text-gray-600 dark:text-gray-400">Create and manage your collaborative wikis. Each wiki can contain multiple pages with rich content.</p>
                </div>

                <div id="wikiGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Wikis will be populated here -->
                </div>

                <div id="emptyWikiState" class="text-center py-16">
                    <i class="fas fa-book-open text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No wikis yet</h3>
                    <p class="text-gray-500 dark:text-gray-500 mb-6">Create your first wiki to get started</p>
                    <button onclick="showCreateWiki()" class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Create Your First Wiki
                    </button>
                </div>
            </div>

            <!-- Create Wiki View -->
            <div id="createWikiView" class="hidden max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Create New Wiki</h2>
                <form onsubmit="createWiki(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Wiki Name</label>
                        <input type="text" id="wikiName" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 text-base">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                        <textarea id="wikiDescription" rows="4" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 text-base" placeholder="Describe what this wiki is about..."></textarea>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create Wiki
                        </button>
                        <button type="button" onclick="showWikiList()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Wiki View -->
            <div id="wikiView" class="hidden">
                <div class="mb-6">
                    <h2 id="wikiTitle" class="text-3xl font-bold text-gray-900 dark:text-white mb-2"></h2>
                    <p id="wikiViewDescription" class="text-gray-600 dark:text-gray-400 mb-4"></p>
                    <div id="wikiActions" class="flex flex-wrap gap-3">
                        <button id="newPageBtn" onclick="showCreatePage()" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-file-plus mr-2"></i>New Page
                        </button>
                        <button id="editWikiBtn" onclick="editWiki()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-edit mr-2"></i>Edit Wiki
                        </button>
                        <button id="manageUsersBtn" onclick="showUserManagement()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-users mr-2"></i>Manage Users
                        </button>
                        <button id="deleteWikiBtn" onclick="deleteWiki()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-trash mr-2"></i>Delete Wiki
                        </button>
                    </div>
                </div>

                <div id="wikiPagesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Pages will be populated here -->
                </div>

                <div id="emptyPagesState" class="text-center py-16">
                    <i class="fas fa-file-alt text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No pages yet</h3>
                    <p class="text-gray-500 dark:text-gray-500 mb-6">Create your first page to start building content</p>
                    <button onclick="showCreatePage()" class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg transition-colors">
                        <i class="fas fa-file-plus mr-2"></i>Create First Page
                    </button>
                </div>
            </div>

            <!-- Create/Edit Page View -->
            <div id="editPageView" class="hidden">
                <div class="mb-6">
                    <h2 id="editPageTitle" class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Create New Page</h2>
                </div>

                <form onsubmit="savePage(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Page Title</label>
                        <input type="text" id="pageTitle" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 text-base">
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Content (Markdown)</label>
                            <textarea id="pageContentEditor" rows="20" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-800 font-mono text-base" placeholder="Write your content in Markdown..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Preview</label>
                            <div id="pagePreview" class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 min-h-96 bg-gray-50 dark:bg-gray-800 markdown-content overflow-y-auto" style="height: 500px;">
                                <p class="text-gray-500 dark:text-gray-400 italic">Preview will appear here as you type...</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Save Page
                        </button>
                        <button type="button" onclick="cancelEdit()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Page View -->
            <div id="pageView" class="hidden">
                <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <h1 id="pageViewTitle" class="text-4xl font-bold text-gray-900 dark:text-white mb-2"></h1>
                        <p class="text-gray-600 dark:text-gray-400">
                            Last updated: <span id="pageLastUpdated"></span>
                        </p>
                    </div>
                    <div id="pageActions" class="flex gap-3">
                        <button id="editPageBtn" onclick="editCurrentPage()" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-edit mr-2"></i>Edit
                        </button>
                        <button id="deletePageBtn" onclick="deleteCurrentPage()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-trash mr-2"></i>Delete
                        </button>
                    </div>
                </div>

                <div id="pageViewContent" class="prose prose-lg max-w-none markdown-content">
                    <!-- Page content will be rendered here -->
                </div>
            </div>

            <!-- Search Results View -->
            <div id="searchView" class="hidden">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Search Results</h2>
                    <p id="searchQuery" class="text-gray-600 dark:text-gray-400"></p>
                </div>
                <div id="searchResults" class="space-y-4">
                    <!-- Search results will be populated here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Modal for Confirmations -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4" id="confirmTitle"></h3>
            <p class="text-gray-700 dark:text-gray-300 mb-6" id="confirmMessage"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancel" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                <button id="confirmOk" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // App State
        let appState = {
            wikis: [],
            currentWiki: null,
            currentPage: null,
            editingPage: null,
            currentUser: null,
            users: []
        };

        // User Roles and Permissions
        const ROLES = {
            OWNER: 'owner',
            ADMIN: 'admin', 
            EDITOR: 'editor',
            CONTRIBUTOR: 'contributor',
            VIEWER: 'viewer'
        };

        const PERMISSIONS = {
            // Wiki-level permissions
            DELETE_WIKI: 'delete_wiki',
            EDIT_WIKI: 'edit_wiki',
            MANAGE_USERS: 'manage_users',
            
            // Page-level permissions
            CREATE_PAGE: 'create_page',
            EDIT_PAGE: 'edit_page',
            DELETE_PAGE: 'delete_page',
            VIEW_PAGE: 'view_page'
        };

        const ROLE_PERMISSIONS = {
            [ROLES.OWNER]: [
                PERMISSIONS.DELETE_WIKI, PERMISSIONS.EDIT_WIKI, PERMISSIONS.MANAGE_USERS,
                PERMISSIONS.CREATE_PAGE, PERMISSIONS.EDIT_PAGE, PERMISSIONS.DELETE_PAGE, PERMISSIONS.VIEW_PAGE
            ],
            [ROLES.ADMIN]: [
                PERMISSIONS.EDIT_WIKI, PERMISSIONS.MANAGE_USERS,
                PERMISSIONS.CREATE_PAGE, PERMISSIONS.EDIT_PAGE, PERMISSIONS.DELETE_PAGE, PERMISSIONS.VIEW_PAGE
            ],
            [ROLES.EDITOR]: [
                PERMISSIONS.CREATE_PAGE, PERMISSIONS.EDIT_PAGE, PERMISSIONS.DELETE_PAGE, PERMISSIONS.VIEW_PAGE
            ],
            [ROLES.CONTRIBUTOR]: [
                PERMISSIONS.CREATE_PAGE, PERMISSIONS.EDIT_PAGE, PERMISSIONS.VIEW_PAGE
            ],
            [ROLES.VIEWER]: [
                PERMISSIONS.VIEW_PAGE
            ]
        };

        // Permission checking functions
        function hasPermission(permission, wikiId = null) {
            if (!appState.currentUser) return false;
            
            if (wikiId && appState.currentUser.wikiRoles && appState.currentUser.wikiRoles[wikiId]) {
                const role = appState.currentUser.wikiRoles[wikiId];
                return ROLE_PERMISSIONS[role] && ROLE_PERMISSIONS[role].includes(permission);
            }
            
            return false;
        }

        function getUserRole(wikiId) {
            if (!appState.currentUser || !appState.currentUser.wikiRoles) return null;
            return appState.currentUser.wikiRoles[wikiId] || null;
        }

        function canAccessWiki(wiki) {
            if (!appState.currentUser) return false;
            return getUserRole(wiki.id) !== null;
        }

        // Initialize app
        function initApp() {
            initDemoUsers();
            showWikiList();
            updateSidebar();
            updateUIBasedOnUser();
        }

        function initDemoUsers() {
            appState.users = [
                {
                    id: 'admin',
                    username: 'admin',
                    password: 'admin',
                    wikiRoles: {}
                },
                {
                    id: 'editor',
                    username: 'editor', 
                    password: 'editor',
                    wikiRoles: {}
                },
                {
                    id: 'viewer',
                    username: 'viewer',
                    password: 'viewer',
                    wikiRoles: {}
                }
            ];
        }

        // User Management
        function showLogin() {
            hideAllViews();
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            updateBreadcrumb([{text: 'Login'}]);
            toggleUserDropdown();
        }

        function performLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = appState.users.find(u => u.username === username && u.password === password);
            if (user) {
                appState.currentUser = user;
                updateUIBasedOnUser();
                showWikiList();
            } else {
                showAlert('Invalid username or password');
            }
        }

        function logout() {
            appState.currentUser = null;
            appState.currentWiki = null;
            appState.currentPage = null;
            updateUIBasedOnUser();
            showWikiList();
            toggleUserDropdown();
        }

        function toggleUserDropdown() {
            const menu = document.getElementById('userDropdownMenu');
            menu.classList.toggle('hidden');
        }

        function updateUIBasedOnUser() {
            const currentUserName = document.getElementById('currentUserName');
            const loginSection = document.getElementById('loginSection');
            const userSection = document.getElementById('userSection');
            
            if (appState.currentUser) {
                currentUserName.textContent = appState.currentUser.username;
                loginSection.classList.add('hidden');
                userSection.classList.remove('hidden');
            } else {
                currentUserName.textContent = 'Guest';
                loginSection.classList.remove('hidden');
                userSection.classList.add('hidden');
            }
            
            updateButtonsBasedOnPermissions();
        }

        function updateButtonsBasedOnPermissions() {
            // Update UI elements based on current user permissions
            const wikiId = appState.currentWiki?.id;
            
            // Create wiki button
            const createWikiBtn = document.getElementById('createWikiBtn');
            if (createWikiBtn) {
                createWikiBtn.style.display = appState.currentUser ? 'block' : 'none';
            }
            
            if (wikiId) {
                // Wiki-level buttons
                const editWikiBtn = document.getElementById('editWikiBtn');
                const deleteWikiBtn = document.getElementById('deleteWikiBtn');
                const manageUsersBtn = document.getElementById('manageUsersBtn');
                const createPageBtn = document.getElementById('createPageBtn');
                const newPageBtn = document.getElementById('newPageBtn');
                
                if (editWikiBtn) editWikiBtn.style.display = hasPermission(PERMISSIONS.EDIT_WIKI, wikiId) ? 'inline-block' : 'none';
                if (deleteWikiBtn) deleteWikiBtn.style.display = hasPermission(PERMISSIONS.DELETE_WIKI, wikiId) ? 'inline-block' : 'none';
                if (manageUsersBtn) manageUsersBtn.style.display = hasPermission(PERMISSIONS.MANAGE_USERS, wikiId) ? 'inline-block' : 'none';
                if (createPageBtn) createPageBtn.style.display = hasPermission(PERMISSIONS.CREATE_PAGE, wikiId) ? 'block' : 'none';
                if (newPageBtn) newPageBtn.style.display = hasPermission(PERMISSIONS.CREATE_PAGE, wikiId) ? 'inline-block' : 'none';
                
                // Page-level buttons
                const editPageBtn = document.getElementById('editPageBtn');
                const deletePageBtn = document.getElementById('deletePageBtn');
                
                if (editPageBtn) editPageBtn.style.display = hasPermission(PERMISSIONS.EDIT_PAGE, wikiId) ? 'inline-block' : 'none';
                if (deletePageBtn) deletePageBtn.style.display = hasPermission(PERMISSIONS.DELETE_PAGE, wikiId) ? 'inline-block' : 'none';
                
                // Update current user role display
                const currentUserRole = document.getElementById('currentUserRole');
                if (currentUserRole) {
                    const role = getUserRole(wikiId);
                    currentUserRole.textContent = role ? `Role: ${role.charAt(0).toUpperCase() + role.slice(1)}` : '';
                }
            }
        }

        // User Management UI
        function showUserManagement() {
            if (!appState.currentWiki || !hasPermission(PERMISSIONS.MANAGE_USERS, appState.currentWiki.id)) {
                showAlert('You do not have permission to manage users for this wiki.');
                return;
            }
            
            hideAllViews();
            document.getElementById('userManagementView').classList.remove('hidden');
            updateBreadcrumb([
                {text: appState.currentWiki.name, action: () => showWiki(appState.currentWiki.id)},
                {text: 'Manage Users'}
            ]);
            renderUsersList();
            toggleUserDropdown();
        }

        function renderUsersList() {
            const usersList = document.getElementById('usersList');
            const wikiUsers = appState.currentWiki.users || [];
            
            if (wikiUsers.length === 0) {
                usersList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">No users assigned to this wiki yet.</p>';
                return;
            }
            
            usersList.innerHTML = wikiUsers.map(wikiUser => {
                const user = appState.users.find(u => u.id === wikiUser.userId);
                if (!user) return '';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900 dark:text-white">${user.username}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Role: ${wikiUser.role.charAt(0).toUpperCase() + wikiUser.role.slice(1)}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <select onchange="changeUserRole('${user.id}', this.value)" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm dark:bg-gray-800">
                                <option value="viewer" ${wikiUser.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                <option value="contributor" ${wikiUser.role === 'contributor' ? 'selected' : ''}>Contributor</option>
                                <option value="editor" ${wikiUser.role === 'editor' ? 'selected' : ''}>Editor</option>
                                <option value="admin" ${wikiUser.role === 'admin' ? 'selected' : ''}>Admin</option>
                                ${getUserRole(appState.currentWiki.id) === 'owner' ? `<option value="owner" ${wikiUser.role === 'owner' ? 'selected' : ''}>Owner</option>` : ''}
                            </select>
                            <button onclick="removeUserFromWiki('${user.id}')" class="text-red-500 hover:text-red-700 p-1">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddUser() {
            document.getElementById('addUserForm').classList.remove('hidden');
        }

        function hideAddUser() {
            document.getElementById('addUserForm').classList.add('hidden');
            document.getElementById('addUserUsername').value = '';
            document.getElementById('addUserRole').value = 'viewer';
        }

        function addUserToWiki(event) {
            event.preventDefault();
            const username = document.getElementById('addUserUsername').value.trim();
            const role = document.getElementById('addUserRole').value;
            
            const user = appState.users.find(u => u.username === username);
            if (!user) {
                showAlert('User not found');
                return;
            }
            
            if (!appState.currentWiki.users) {
                appState.currentWiki.users = [];
            }
            
            const existingUser = appState.currentWiki.users.find(u => u.userId === user.id);
            if (existingUser) {
                showAlert('User is already a member of this wiki');
                return;
            }
            
            appState.currentWiki.users.push({
                userId: user.id,
                role: role,
                addedAt: new Date().toISOString()
            });
            
            // Update user's wiki roles
            if (!user.wikiRoles) user.wikiRoles = {};
            user.wikiRoles[appState.currentWiki.id] = role;
            
            renderUsersList();
            hideAddUser();
        }

        function changeUserRole(userId, newRole) {
            const wikiUser = appState.currentWiki.users.find(u => u.userId === userId);
            const user = appState.users.find(u => u.id === userId);
            
            if (wikiUser && user) {
                wikiUser.role = newRole;
                if (!user.wikiRoles) user.wikiRoles = {};
                user.wikiRoles[appState.currentWiki.id] = newRole;
                
                // Update current user permissions if they changed their own role
                if (appState.currentUser && appState.currentUser.id === userId) {
                    updateButtonsBasedOnPermissions();
                }
            }
        }

        function removeUserFromWiki(userId) {
            showConfirmDialog(
                'Remove User',
                'Are you sure you want to remove this user from the wiki?',
                () => {
                    appState.currentWiki.users = appState.currentWiki.users.filter(u => u.userId !== userId);
                    const user = appState.users.find(u => u.id === userId);
                    if (user && user.wikiRoles) {
                        delete user.wikiRoles[appState.currentWiki.id];
                    }
                    renderUsersList();
                }
            );
        }

        // Custom confirmation dialog
        function showConfirmDialog(title, message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const cancelBtn = document.getElementById('confirmCancel');
            const okBtn = document.getElementById('confirmOk');
            
            const hideModal = () => modal.classList.add('hidden');
            
            cancelBtn.onclick = hideModal;
            okBtn.onclick = () => {
                hideModal();
                onConfirm();
            };
            
            modal.classList.remove('hidden');
        }

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Notice</h3>
                    <p class="text-gray-700 dark:text-gray-300 mb-6">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // View Management
        function hideAllViews() {
            document.querySelectorAll('#wikiListView, #createWikiView, #wikiView, #editPageView, #pageView, #searchView, #loginView, #userManagementView').forEach(view => {
                view.classList.add('hidden');
            });
        }

        function showWikiList() {
            hideAllViews();
            document.getElementById('wikiListView').classList.remove('hidden');
            appState.currentWiki = null;
            appState.currentPage = null;
            updateBreadcrumb([]);
            updateSidebar();
            renderWikis();
            updateButtonsBasedOnPermissions();
        }

        function showCreateWiki() {
            if (!appState.currentUser) {
                showAlert('Please login to create a wiki.');
                return;
            }
            
            hideAllViews();
            document.getElementById('createWikiView').classList.remove('hidden');
            document.getElementById('wikiName').value = '';
            document.getElementById('wikiDescription').value = '';
            updateBreadcrumb([{text: 'Create Wiki'}]);
        }

        function showWiki(wikiId) {
            const wiki = appState.wikis.find(w => w.id === wikiId);
            if (!wiki || !canAccessWiki(wiki)) {
                showAlert('You do not have access to this wiki.');
                return;
            }

            hideAllViews();
            document.getElementById('wikiView').classList.remove('hidden');
            appState.currentWiki = wiki;
            appState.currentPage = null;
            
            document.getElementById('wikiTitle').textContent = wiki.name;
            document.getElementById('wikiViewDescription').textContent = wiki.description;
            
            updateBreadcrumb([{text: wiki.name}]);
            updateSidebar();
            updateButtonsBasedOnPermissions();
            renderWikiPages();
        }

        function showCreatePage() {
            if (!appState.currentWiki || !hasPermission(PERMISSIONS.CREATE_PAGE, appState.currentWiki.id)) {
                showAlert('You do not have permission to create pages in this wiki.');
                return;
            }
            
            hideAllViews();
            document.getElementById('editPageView').classList.remove('hidden');
            document.getElementById('editPageTitle').textContent = 'Create New Page';
            
            document.getElementById('pageTitle').value = '';
            document.getElementById('pageContentEditor').value = '';
            document.getElementById('pagePreview').innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">Preview will appear here as you type...</p>';
            
            appState.editingPage = null;
            updateBreadcrumb([
                {text: appState.currentWiki.name, action: () => showWiki(appState.currentWiki.id)},
                {text: 'New Page'}
            ]);
        }

        function showPage(pageId) {
            const wiki = appState.currentWiki;
            if (!wiki || !hasPermission(PERMISSIONS.VIEW_PAGE, wiki.id)) {
                showAlert('You do not have permission to view pages in this wiki.');
                return;
            }
            
            const page = wiki.pages.find(p => p.id === pageId);
            if (!page) return;

            hideAllViews();
            document.getElementById('pageView').classList.remove('hidden');
            appState.currentPage = page;
            
            document.getElementById('pageViewTitle').textContent = page.title;
            document.getElementById('pageLastUpdated').textContent = new Date(page.lastUpdated).toLocaleString();
            document.getElementById('pageViewContent').innerHTML = marked.parse(page.content);
            
            updateBreadcrumb([
                {text: wiki.name, action: () => showWiki(wiki.id)},
                {text: page.title}
            ]);
            updateButtonsBasedOnPermissions();
        }

        function editCurrentPage() {
            if (!appState.currentPage || !hasPermission(PERMISSIONS.EDIT_PAGE, appState.currentWiki.id)) {
                showAlert('You do not have permission to edit pages in this wiki.');
                return;
            }
            
            hideAllViews();
            document.getElementById('editPageView').classList.remove('hidden');
            document.getElementById('editPageTitle').textContent = 'Edit Page';
            
            document.getElementById('pageTitle').value = appState.currentPage.title;
            document.getElementById('pageContentEditor').value = appState.currentPage.content;
            updatePreview();
            
            appState.editingPage = appState.currentPage;
            updateBreadcrumb([
                {text: appState.currentWiki.name, action: () => showWiki(appState.currentWiki.id)},
                {text: appState.currentPage.title, action: () => showPage(appState.currentPage.id)},
                {text: 'Edit'}
            ]);
        }

        function cancelEdit() {
            if (appState.editingPage) {
                showPage(appState.editingPage.id);
            } else {
                showWiki(appState.currentWiki.id);
            }
        }

        // Wiki Management
        function createWiki(event) {
            event.preventDefault();
            
            if (!appState.currentUser) {
                showAlert('Please login to create a wiki.');
                return;
            }
            
            const name = document.getElementById('wikiName').value.trim();
            const description = document.getElementById('wikiDescription').value.trim();
            
            if (!name) return;
            
            const wiki = {
                id: Date.now().toString(),
                name,
                description,
                pages: [],
                users: [{
                    userId: appState.currentUser.id,
                    role: ROLES.OWNER,
                    addedAt: new Date().toISOString()
                }],
                created: new Date().toISOString()
            };
            
            // Update user's wiki roles
            if (!appState.currentUser.wikiRoles) appState.currentUser.wikiRoles = {};
            appState.currentUser.wikiRoles[wiki.id] = ROLES.OWNER;
            
            appState.wikis.push(wiki);
            showWiki(wiki.id);
        }

        function editWiki() {
            if (!appState.currentWiki || !hasPermission(PERMISSIONS.EDIT_WIKI, appState.currentWiki.id)) {
                showAlert('You do not have permission to edit this wiki.');
                return;
            }
            
            hideAllViews();
            document.getElementById('createWikiView').classList.remove('hidden');
            document.getElementById('wikiName').value = appState.currentWiki.name;
            document.getElementById('wikiDescription').value = appState.currentWiki.description;
            
            // Change form submission handler temporarily
            const form = document.querySelector('#createWikiView form');
            form.onsubmit = updateWiki;
            
            updateBreadcrumb([
                {text: appState.currentWiki.name, action: () => showWiki(appState.currentWiki.id)},
                {text: 'Edit'}
            ]);
        }

        function updateWiki(event) {
            event.preventDefault();
            
            const name = document.getElementById('wikiName').value.trim();
            const description = document.getElementById('wikiDescription').value.trim();
            
            if (!name || !appState.currentWiki) return;
            
            appState.currentWiki.name = name;
            appState.currentWiki.description = description;
            
            // Reset form handler
            const form = document.querySelector('#createWikiView form');
            form.onsubmit = createWiki;
            
            showWiki(appState.currentWiki.id);
        }

        function deleteWiki() {
            if (!appState.currentWiki || !hasPermission(PERMISSIONS.DELETE_WIKI, appState.currentWiki.id)) {
                showAlert('You do not have permission to delete this wiki.');
                return;
            }
            
            showConfirmDialog(
                'Delete Wiki',
                `Are you sure you want to delete "${appState.currentWiki.name}"? This action cannot be undone.`,
                () => {
                    // Remove wiki from users' roles
                    appState.users.forEach(user => {
                        if (user.wikiRoles && user.wikiRoles[appState.currentWiki.id]) {
                            delete user.wikiRoles[appState.currentWiki.id];
                        }
                    });
                    
                    appState.wikis = appState.wikis.filter(w => w.id !== appState.currentWiki.id);
                    showWikiList();
                }
            );
        }

        // Page Management
        function savePage(event) {
            event.preventDefault();
            
            const title = document.getElementById('pageTitle').value.trim();
            const content = document.getElementById('pageContentEditor').value;
            
            if (!title || !appState.currentWiki) return;
            
            const requiredPermission = appState.editingPage ? PERMISSIONS.EDIT_PAGE : PERMISSIONS.CREATE_PAGE;
            if (!hasPermission(requiredPermission, appState.currentWiki.id)) {
                showAlert(`You do not have permission to ${appState.editingPage ? 'edit' : 'create'} pages in this wiki.`);
                return;
            }
            
            if (appState.editingPage) {
                // Update existing page
                appState.editingPage.title = title;
                appState.editingPage.content = content;
                appState.editingPage.lastUpdated = new Date().toISOString();
                showPage(appState.editingPage.id);
            } else {
                // Create new page
                const page = {
                    id: Date.now().toString(),
                    title,
                    content,
                    created: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                };
                
                appState.currentWiki.pages.push(page);
                showPage(page.id);
            }
            
            updateSidebar();
        }

        function deleteCurrentPage() {
            if (!appState.currentPage || !appState.currentWiki || !hasPermission(PERMISSIONS.DELETE_PAGE, appState.currentWiki.id)) {
                showAlert('You do not have permission to delete pages in this wiki.');
                return;
            }
            
            showConfirmDialog(
                'Delete Page',
                `Are you sure you want to delete "${appState.currentPage.title}"? This action cannot be undone.`,
                () => {
                    appState.currentWiki.pages = appState.currentWiki.pages.filter(p => p.id !== appState.currentPage.id);
                    showWiki(appState.currentWiki.id);
                    updateSidebar();
                }
            );
        }

        // Markdown Preview
        function updatePreview() {
            const content = document.getElementById('pageContentEditor').value;
            const preview = document.getElementById('pagePreview');
            
            if (content.trim()) {
                preview.innerHTML = marked.parse(content);
            } else {
                preview.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">Preview will appear here as you type...</p>';
            }
        }

        // Search
        function handleSearchKeypress(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) return;
            
            hideAllViews();
            document.getElementById('searchView').classList.remove('hidden');
            document.getElementById('searchQuery').textContent = `Results for: "${query}"`;
            
            const results = [];
            
            appState.wikis.forEach(wiki => {
                if (canAccessWiki(wiki)) {
                    wiki.pages.forEach(page => {
                        if (page.title.toLowerCase().includes(query) || page.content.toLowerCase().includes(query)) {
                            results.push({
                                wiki,
                                page,
                                score: (page.title.toLowerCase().includes(query) ? 2 : 0) + 
                                       (page.content.toLowerCase().includes(query) ? 1 : 0)
                            });
                        }
                    });
                }
            });
            
            results.sort((a, b) => b.score - a.score);
            renderSearchResults(results);
            updateBreadcrumb([{text: `Search: ${query}`}]);
        }

        function renderSearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-search text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
                        <p class="text-gray-500 dark:text-gray-400">No results found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = results.map(result => `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow cursor-pointer" onclick="openSearchResult('${result.wiki.id}', '${result.page.id}')">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">${result.page.title}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">In wiki: ${result.wiki.name}</p>
                    <p class="text-gray-700 dark:text-gray-300 line-clamp-3">${result.page.content.substring(0, 200)}...</p>
                </div>
            `).join('');
        }

        function openSearchResult(wikiId, pageId) {
            const wiki = appState.wikis.find(w => w.id === wikiId);
            if (wiki && canAccessWiki(wiki)) {
                appState.currentWiki = wiki;
                showPage(pageId);
                updateSidebar();
            }
        }

        // UI Updates
        function updateBreadcrumb(items) {
            const breadcrumb = document.getElementById('breadcrumb');
            
            if (items.length === 0) {
                breadcrumb.innerHTML = '';
                return;
            }
            
            breadcrumb.innerHTML = items.map((item, index) => {
                const isLast = index === items.length - 1;
                const classes = isLast ? 'text-white' : 'text-white text-opacity-75 hover:text-white cursor-pointer';
                const onclick = item.action ? `onclick="(${item.action.toString()})()"` : '';
                
                return `
                    <span class="${classes}" ${onclick}>${item.text}</span>
                    ${!isLast ? '<i class="fas fa-chevron-right text-xs opacity-50"></i>' : ''}
                `;
            }).join('');
        }

        function updateSidebar() {
            const currentWikiInfo = document.getElementById('currentWikiInfo');
            const pagesList = document.getElementById('pagesList');
            
            if (appState.currentWiki && canAccessWiki(appState.currentWiki)) {
                currentWikiInfo.classList.remove('hidden');
                document.getElementById('currentWikiName').textContent = appState.currentWiki.name;
                document.getElementById('currentWikiDesc').textContent = appState.currentWiki.description;
                
                if (appState.currentWiki.pages.length > 0) {
                    pagesList.innerHTML = appState.currentWiki.pages.map(page => `
                        <div class="p-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer flex items-center" onclick="showPage('${page.id}')">
                            <i class="fas fa-file-alt mr-2 text-xs"></i>
                            <span class="truncate">${page.title}</span>
                        </div>
                    `).join('');
                } else {
                    pagesList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 italic">No pages yet</p>';
                }
            } else {
                currentWikiInfo.classList.add('hidden');
            }
        }

        function renderWikis() {
            const grid = document.getElementById('wikiGrid');
            const emptyState = document.getElementById('emptyWikiState');
            
            const accessibleWikis = appState.wikis.filter(wiki => !appState.currentUser || canAccessWiki(wiki));
            
            if (accessibleWikis.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            grid.innerHTML = accessibleWikis.map(wiki => {
                const userRole = appState.currentUser ? getUserRole(wiki.id) : null;
                const roleDisplay = userRole ? `<span class="text-xs bg-primary text-white px-2 py-1 rounded-full">${userRole}</span>` : '';
                
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow cursor-pointer" onclick="showWiki('${wiki.id}')">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">${wiki.name}</h3>
                            ${roleDisplay}
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 mb-4 line-clamp-2">${wiki.description || 'No description'}</p>
                        <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
                            <span><i class="fas fa-file-alt mr-1"></i>${wiki.pages.length} pages</span>
                            <span><i class="fas fa-calendar mr-1"></i>${new Date(wiki.created).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderWikiPages() {
            const grid = document.getElementById('wikiPagesGrid');
            const emptyState = document.getElementById('emptyPagesState');
            
            if (!appState.currentWiki || appState.currentWiki.pages.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            grid.innerHTML = appState.currentWiki.pages.map(page => `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow cursor-pointer" onclick="showPage('${page.id}')">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">${page.title}</h4>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-3 line-clamp-3">${page.content.substring(0, 100)}...</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-clock mr-1"></i>Updated ${new Date(page.lastUpdated).toLocaleDateString()}
                    </p>
                </div>
            `).join('');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        // Real-time preview update
        document.addEventListener('DOMContentLoaded', function() {
            const pageContentTextarea = document.getElementById('pageContentEditor');
            if (pageContentTextarea) {
                pageContentTextarea.addEventListener('input', updatePreview);
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('userDropdownMenu');
                const button = document.getElementById('userDropdown');
                
                if (!button.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        });

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', initApp);

        // Add some sample data for demonstration
        setTimeout(() => {
            if (appState.wikis.length === 0) {
                // Create a demo wiki with some users
                const demoWiki = {
                    id: 'demo1',
                    name: 'Getting Started Guide',
                    description: 'Learn how to use WikiBuilder effectively',
                    created: new Date().toISOString(),
                    users: [
                        { userId: 'admin', role: 'owner', addedAt: new Date().toISOString() },
                        { userId: 'editor', role: 'editor', addedAt: new Date().toISOString() },
                        { userId: 'viewer', role: 'viewer', addedAt: new Date().toISOString() }
                    ],
                    pages: [
                        {
                            id: 'demo-page1',
                            title: 'Welcome to WikiBuilder',
                            content: `# Welcome to WikiBuilder

This is your first page! WikiBuilder is a powerful wiki platform that lets you create and organize knowledge with role-based permissions.

## User Roles

WikiBuilder supports different user roles with varying levels of access:

- **Owner**: Full control over the wiki, including deletion and user management
- **Admin**: Can manage users and edit wiki settings, but cannot delete the wiki
- **Editor**: Can create, edit, and delete pages
- **Contributor**: Can create and edit pages, but cannot delete them
- **Viewer**: Read-only access to wiki content

## Features

- **Markdown Support**: Write content using familiar markdown syntax
- **Real-time Preview**: See your changes as you type
- **Role-based Permissions**: Control who can do what in your wikis
- **User Management**: Add and remove users, assign roles
- **Responsive Design**: Works great on all devices
- **Dark Mode**: Automatically adapts to your system preferences

## Getting Started

1. Login using one of the demo accounts (admin/admin, editor/editor, viewer/viewer)
2. Create a new wiki or explore existing ones
3. Add users and assign appropriate roles
4. Create pages and start organizing your knowledge
5. Use the search feature to find content across all your wikis

## Demo Users

Try logging in with these demo accounts to see different permission levels:

- **admin/admin**: Full admin access
- **editor/editor**: Can edit pages but not manage users
- **viewer/viewer**: Read-only access

Happy wiki building! 🚀`,
                            created: new Date().toISOString(),
                            lastUpdated: new Date().toISOString()
                        }
                    ]
                };
                
                appState.wikis.push(demoWiki);
                
                // Update demo users with wiki roles
                appState.users.forEach(user => {
                    const wikiUser = demoWiki.users.find(u => u.userId === user.id);
                    if (wikiUser) {
                        if (!user.wikiRoles) user.wikiRoles = {};
                        user.wikiRoles[demoWiki.id] = wikiUser.role;
                    }
                });
                
                renderWikis();
            }
        }, 100);
    </script>
</body>
</html>
